<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Famiglia di Chris</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            /* Sfondo allegro */
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            touch-action: manipulation;
            user-select: none;
        }

        /* Schermata Iniziale */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #start-btn {
            background: #FF9800; color: white; border: none; padding: 20px 50px;
            font-size: 2rem; border-radius: 50px; margin-top: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
            animation: bounce 1s infinite;
        }
        h1 { margin: 0; color: #333; }
        p { font-size: 1.2rem; color: #666; }

        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Contenitore Gioco */
        #game-container {
            position: relative; width: 100vw; height: 100vh; overflow: hidden;
        }

        /* La Bolla */
        .bubble {
            position: absolute; bottom: -150px;
            width: 130px; height: 130px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            overflow: hidden; /* Importante per ritagliare la faccia tonda */
            cursor: pointer;
            animation: floatUp linear forwards;
            -webkit-tap-highlight-color: transparent;
            background-color: #eee; /* Colore di caricamento */
        }

        /* L'immagine dentro la bolla (Sprite) */
        .face-img {
            width: 100%; height: 100%;
            background-image: url('famiglia.jpg'); /* DEVE ESSERE NELLA STESSA CARTELLA */
            background-size: 400% 500%; /* 4 colonne, 5 righe circa */
            background-repeat: no-repeat;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) rotate(-5deg); }
            100% { transform: translateY(-120vh) rotate(5deg); }
        }

        /* Animazione Scoppio */
        .pop-anim { animation: popEffect 0.2s ease-out forwards; }
        @keyframes popEffect {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* Particelle */
        .particle { position: absolute; width: 12px; height: 12px; border-radius: 50%; pointer-events: none; }

        /* Messaggio errore immagine */
        #img-warning {
            color: red; font-size: 12px; position: absolute; bottom: 10px; width: 100%; text-align: center;
            display: none;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ La Famiglia di Chris</h1>
        <p>Tocca i visi per salutarli!</p>
        <button id="start-btn">GIOCA ‚ñ∂Ô∏è</button>
        <div id="img-warning">‚ö†Ô∏è Assicurati che il file si chiami <b>famiglia.jpg</b></div>
    </div>

    <div id="game-container"></div>

    <script>
        const container = document.getElementById('game-container');
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');
        
        let gameActive = false;
        let spawnRate = 1300; 

        // --- DEFINIZIONE GRIGLIA FAMIGLIA ---
        // Basato sull'immagine: 4 colonne, 5 righe.
        // Coordinate x, y in percentuale (0, 1, 2, 3 per colonne; 0, 1, 2, 3, 4 per righe)
        
        const family = [
            // Riga 1
            { name: "Pap√† Gabriele", role: "Pap√†", x: 0, y: 0, color: "#2196F3" },
            { name: "Julie", role: "La sorellina", x: 1, y: 0, color: "#E91E63" },
            { name: "Mamma Jessica", role: "Mamma", x: 2, y: 0, color: "#E91E63" },
            { name: "Christopher", role: "Sei tu Chris!", x: 3, y: 0, color: "#FF9800" },
            
            // Riga 2
            { name: "Nonna Letizia", role: "Nonna", x: 0, y: 1, color: "#9C27B0" },
            { name: "Zia Rosa", role: "Zia", x: 1, y: 1, color: "#673AB7" }, // Assumo Zia/Nonna
            { name: "Nonna Lucia", role: "Nonna", x: 2, y: 1, color: "#9C27B0" },
            { name: "Nonno Fiore", role: "Nonno", x: 3, y: 1, color: "#4CAF50" },

            // Riga 3
            { name: "Beatrice", role: "Zia", x: 0, y: 2, color: "#FF5722" },
            { name: "Lorenzo", role: "Zio", x: 1, y: 2, color: "#795548" },
            { name: "Zio Loris", role: "Zio", x: 2, y: 2, color: "#3F51B5" },
            { name: "Nonna Sonia", role: "Nonna", x: 3, y: 2, color: "#E91E63" },

            // Riga 4
            { name: "Nonno Ugo", role: "Nonno", x: 0, y: 3, color: "#8BC34A" }, // Ugo
            { name: "Nicolas", role: "Zio", x: 1, y: 3, color: "#009688" },
            { name: "Alessia", role: "Zia", x: 2, y: 3, color: "#607D8B" },
            { name: "Alla", role: "Zia", x: 3, y: 3, color: "#9E9E9E" }, // Assumo Zia

            // Riga 5 (Solo primi 2)
            { name: "Gianluca", role: "Zio", x: 0, y: 4, color: "#FFC107" },
            { name: "Raffaele", role: "Zio", x: 1, y: 4, color: "#00BCD4" }
        ];

        // Controllo immagine caricata
        const imgCheck = new Image();
        imgCheck.src = 'famiglia.jpg';
        imgCheck.onerror = () => { document.getElementById('img-warning').style.display = 'block'; };

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'it-IT';
            utterance.rate = 0.9;
            utterance.pitch = 1.1; // Voce leggermente allegra
            window.speechSynthesis.speak(utterance);
        }

        function createMember() {
            if (!gameActive) return;

            // Scegli un parente a caso
            const person = family[Math.floor(Math.random() * family.length)];
            
            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.style.borderColor = person.color;
            
            // Posizionamento casuale orizzontale
            const randomLeft = Math.floor(Math.random() * (window.innerWidth - 130));
            bubble.style.left = randomLeft + 'px';

            // Velocit√† variabile
            const duration = Math.random() * 4 + 5; 
            bubble.style.animationDuration = duration + 's';

            // CREAZIONE SPRITE (Il ritaglio della faccia)
            const face = document.createElement('div');
            face.classList.add('face-img');
            
            // Calcolo coordinate Background:
            // L'immagine ha 4 colonne (100% / 3 spazi = 33.33% step)
            // L'immagine ha 5 righe (100% / 4 spazi = 25% step)
            // Nota: background-position usa percentuali relative allo spazio rimanente, calcolo approssimativo per griglie:
            const posX = person.x * (100 / 3); 
            const posY = person.y * (100 / 4); 
            
            face.style.backgroundPosition = `${posX}% ${posY}%`;
            bubble.appendChild(face);

            // Click/Touch
            const touchHandler = (e) => {
                e.preventDefault(); e.stopPropagation();
                popBubble(bubble, person);
            };
            bubble.addEventListener('mousedown', touchHandler);
            bubble.addEventListener('touchstart', touchHandler);

            container.appendChild(bubble);

            // Pulizia
            setTimeout(() => { if(bubble.parentNode) bubble.remove(); }, duration * 1000);
            
            // Loop
            setTimeout(createMember, spawnRate);
        }

        function popBubble(el, person) {
            if(el.classList.contains('popped')) return;
            el.classList.add('popped');

            // Frase random
            const phrases = [
                `Ecco ${person.name}!`,
                `Ciao ${person.name}!`,
                `Hai trovato ${person.name}!`,
                `${person.name}!`
            ];
            const text = phrases[Math.floor(Math.random() * phrases.length)];
            speak(text);

            // Effetti
            el.style.animation = 'none';
            el.classList.add('pop-anim');
            createConfetti(el.offsetLeft + 65, el.offsetTop + 65, person.color);

            setTimeout(() => el.remove(), 200);
        }

        function createConfetti(x, y, color) {
            for(let i=0; i<10; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                p.style.backgroundColor = color;
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                container.appendChild(p);

                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 80 + 40;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                p.animate([
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], { duration: 500, easing: 'ease-out' });
                
                setTimeout(() => p.remove(), 500);
            }
        }

        startBtn.addEventListener('click', () => {
            overlay.style.display = 'none';
            gameActive = true;
            speak("Tocca la famiglia!");
            createMember();
        });

    </script>
</body>
</html>