<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Coach - Analisi Biomeccanica</title>
    <style>
        body, html { margin: 0; padding: 0; background-color: #000; overflow-x: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            grid-gap: 5px;
            padding: 5px;
        }

        .gallery img {
            width: 100%; height: 200px; object-fit: cover;
            display: block; cursor: pointer; transition: 0.2s;
        }

        .gallery img:hover { filter: brightness(1.2); }

        #overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.98);
            z-index: 1000; overflow: hidden; touch-action: none;
        }

        #fullImage {
            position: absolute; cursor: move;
            user-select: none; max-width: none; transform-origin: 0 0;
        }

        #close-btn {
            position: absolute; top: 20px; right: 30px;
            color: white; font-size: 40px; font-weight: bold;
            cursor: pointer; z-index: 1001;
        }

        /* UI Analisi */
        #analyze-btn {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%); padding: 15px 30px;
            background-color: #1a73e8; color: white;
            border: none; border-radius: 30px; cursor: pointer;
            z-index: 1002; font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #analysis-result {
            position: absolute; top: 80px; left: 50%;
            transform: translateX(-50%); width: 85%; max-width: 600px;
            color: #f0f0f0; background: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(12px); padding: 25px;
            display: none; z-index: 1002; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            line-height: 1.6; max-height: 60vh; overflow-y: auto;
            text-align: left;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid #fff; border-radius: 50%;
            width: 18px; height: 18px; animation: spin 0.8s linear infinite;
            display: inline-block; margin-right: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="gallery" id="imageContainer"></div>

    <div id="overlay">
        <span id="close-btn" onclick="closeImage()">&times;</span>
        <div id="analysis-result"></div>
        <img id="fullImage" src="" alt="Dettaglio Macchinario">
        <button id="analyze-btn" onclick="analyzeImage()">Analizza Macchinario</button>
    </div>

    <script>
        const API_KEY = "AIzaSyCQ_ClxoU0lBnEP_YoqUmFJZzNglEmr89w";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        const container = document.getElementById('imageContainer');
        const overlay = document.getElementById('overlay');
        const img = document.getElementById('fullImage');
        const resultDiv = document.getElementById('analysis-result');
        const btn = document.getElementById('analyze-btn');
        
        let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;

        // Inizializzazione Galleria
        for (let i = 1; i <= 54; i++) {
            const el = document.createElement('img');
            el.src = `${i}.jpg`;
            el.crossOrigin = "anonymous"; // Necessario per GitHub Pages
            el.onclick = () => openImage(el.src);
            el.onerror = () => el.style.display = 'none';
            container.appendChild(el);
        }

        function openImage(src) {
            img.src = src;
            scale = 1; pointX = 0; pointY = 0; 
            resultDiv.style.display = "none";
            btn.style.display = "block";
            btn.innerHTML = "Analizza Macchinario";
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            img.onload = () => {
                pointX = (window.innerWidth - img.offsetWidth) / 2;
                pointY = (window.innerHeight - img.offsetHeight) / 2;
                setTransform();
            };
        }

        function closeImage() {
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Funzione Canvas per bypassare CORS ed estrarre i dati immagine
        function getBase64FromImage(imgElement) {
            const canvas = document.createElement("canvas");
            canvas.width = imgElement.naturalWidth;
            canvas.height = imgElement.naturalHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(imgElement, 0, 0);
            return canvas.toDataURL("image/jpeg").split(',')[1];
        }

        async function analyzeImage() {
            btn.innerHTML = `<span class="spinner"></span>Analisi in corso...`;
            resultDiv.style.display = "block";
            resultDiv.innerHTML = "<em>L'IA sta analizzando la biomeccanica del macchinario...</em>";

            try {
                const base64Data = getBase64FromImage(img);
                
                const prompt = "Sei un esperto mondiale di Natural Bodybuilding e biomeccanica. Analizza questa foto: identifica il macchinario, spiega quali muscoli target stimola e dai un consiglio da top coach per massimizzare l'ipertrofia o la sicurezza.";

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    resultDiv.innerHTML = `<strong>ANALISI COACH:</strong><br><br>${aiText.replace(/\n/g, '<br>')}`;
                    btn.style.display = "none";
                } else {
                    throw new Error("Risposta non valida");
                }

            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = "<strong>Errore:</strong> Impossibile completare l'analisi. Verifica che l'immagine sia caricata correttamente.";
                btn.innerHTML = "Riprova";
            }
        }

        // Gestione Zoom e Pan
        function setTransform() { img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }

        overlay.onwheel = (e) => {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = -e.deltaY;
            (delta > 0) ? (scale *= 1.2) : (scale /= 1.2);
            pointX = e.clientX - xs * scale;
            pointY = e.clientY - ys * scale;
            setTransform();
        };

        overlay.onmousedown = (e) => { if (e.target === img) { e.preventDefault(); startX = e.clientX - pointX; startY = e.clientY - pointY; panning = true; } };
        overlay.onmouseup = () => { panning = false; };
        overlay.onmousemove = (e) => { if (!panning) return; pointX = e.clientX - startX; pointY = e.clientY - startY; setTransform(); };
        document.addEventListener('keydown', (e) => { if (e.key === "Escape") closeImage(); });
    </script>
</body>
</html>