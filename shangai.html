<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chris Gravity Game - Debug Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; color: white; }
        canvas { display: block; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8); z-index: 10;
        }
        #debug { position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: #0f0; pointer-events: none; }
        button { 
            padding: 25px 50px; font-size: 28px; font-weight: bold;
            background: #4CAF50; color: white; border: none; border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="text-align: center; padding: 20px;">Pronto per Chris?</h1>
        <button id="startBtn">GIOCA ORA</button>
        <p style="margin-top: 20px; color: #aaa;">Usa il telefono in verticale</p>
    </div>

    <div id="debug">Attesa sensori...</div>
    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const overlay = document.getElementById('overlay');
const debugEl = document.getElementById('debug');

let ball = { x: 0, y: 0, radius: 25, vx: 0, vy: 0 };
let sticks = [];
let score = 0;

function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    createSticks();
}

function createSticks() {
    sticks = [];
    for (let i = 0; i < 10; i++) {
        sticks.push({
            x: Math.random() * (canvas.width - 100) + 50,
            y: Math.random() * (canvas.height - 100) + 50,
            w: 10, h: 120,
            angle: Math.random() * Math.PI,
            color: `hsl(${Math.random() * 360}, 70%, 60%)`,
            active: true
        });
    }
}

function handleOrientation(event) {
    // Debug dei dati grezzi
    debugEl.innerHTML = `Beta: ${Math.round(event.beta)} | Gamma: ${Math.round(event.gamma)}`;
    
    // Mappatura: Beta (avanti/dietro), Gamma (sinistra/destra)
    // SensibilitÃ  regolata per le mani di un bimbo
    ball.vx = event.gamma * 0.15; 
    ball.vy = event.beta * 0.15;
}

async function requestPermissions() {
    // Caso iOS 13+
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
            const permissionState = await DeviceOrientationEvent.requestPermission();
            if (permissionState === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation);
                startGame();
            } else {
                alert("Permesso negato! Controlla le impostazioni di Safari.");
            }
        } catch (e) {
            alert("Errore richiesta permessi: " + e);
        }
    } else {
        // Android o browser desktop/vecchi
        window.addEventListener('deviceorientation', handleOrientation);
        startGame();
    }
}

function startGame() {
    overlay.style.display = 'none';
    init();
    animate();
}

function animate() {
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Movimento pallina
    ball.x += ball.vx;
    ball.y += ball.vy;

    // Rimbalzo bordi
    if (ball.x < ball.radius) ball.x = ball.radius;
    if (ball.x > canvas.width - ball.radius) ball.x = canvas.width - ball.radius;
    if (ball.y < ball.radius) ball.y = ball.radius;
    if (ball.y > canvas.height - ball.radius) ball.y = canvas.height - ball.radius;

    // Disegna bastoncini
    sticks.forEach(s => {
        if (!s.active) return;
        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.angle);
        ctx.fillStyle = s.color;
        ctx.fillRect(-s.w/2, -s.h/2, s.w, s.h);
        ctx.restore();

        // Collisione semplificata
        let dist = Math.hypot(ball.x - s.x, ball.y - s.y);
        if (dist < ball.radius + 20) {
            s.active = false;
            score++;
            if (sticks.every(st => !st.active)) createSticks();
        }
    });

    // Disegna Chris (la pallina)
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#4CAF50';
    ctx.stroke();

    requestAnimationFrame(animate);
}

startBtn.addEventListener('click', requestPermissions);
window.addEventListener('resize', init);
</script>
</body>
</html>